{"pageProps":{"bundle":"!function(e,t){\"object\"==typeof exports&&\"object\"==typeof module?module.exports=t(require(\"mdxJsReact\"),require(\"React\")):\"function\"==typeof define&&define.amd?define([\"mdxJsReact\",\"React\"],t):\"object\"==typeof exports?exports.MDXContent=t(require(\"mdxJsReact\"),require(\"React\")):e.MDXContent=t(e.mdxJsReact,e.React)}(this,((e,t)=>(()=>{\"use strict\";var n={24:e=>{e.exports=t},825:t=>{t.exports=e}},l={};function a(e){var t=l[e];if(void 0!==t)return t.exports;var r=l[e]={exports:{}};return n[e](r,r.exports,a),r.exports}a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var n in t)a.o(t,n)&&!a.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})};var r={};return(()=>{a.r(r),a.d(r,{default:()=>l});var e=a(825),t=a(24),n=a.n(t);const l=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},l=Object.assign({},(0,e.useMDXComponents)(),t.components),a=l.wrapper;return a?n().createElement(a,t,n().createElement(r)):r();function r(){var l=Object.assign({p:\"p\",h2:\"h2\",a:\"a\",pre:\"pre\",code:\"code\",ul:\"ul\",li:\"li\",h3:\"h3\",ol:\"ol\",h4:\"h4\",strong:\"strong\",table:\"table\",thead:\"thead\",tr:\"tr\",th:\"th\",tbody:\"tbody\",td:\"td\"},(0,e.useMDXComponents)(),t.components);return n().createElement(n().Fragment,null,n().createElement(l.p,null,\"The following information is intended for use by the CI Systems team.\\nSome of the documented commands or instructions may assume that you\\nhave privileged access to Orka, Vault, etc.\"),\"\\n\",n().createElement(l.h2,{id:\"connecting-to-the-vpn\"},\"Connecting to the VPN\"),\"\\n\",n().createElement(l.p,null,\"In order to use the Orka CLI, UI, or API, you must first use a VPN to\\nconnect to the Orka network.  (The CI agent networks are already\\nconnected.)\"),\"\\n\",n().createElement(l.p,null,\"First, follow the \",n().createElement(l.a,{href:\"https://orkadocs.macstadium.com/docs/vpn-connect\"},\"instructions to download and install the VPN\\nclient\"),\".\"),\"\\n\",n().createElement(l.p,null,\"The connection details are stored in \",n().createElement(l.a,{href:\"secret/macstadium/orka/ORKV10000025\"},\"this Vault\\nkey\"),\".\"),\"\\n\",n().createElement(l.p,null,\"If you are on Linux or Mac then you can use the following to easily\\nconnect:\"),\"\\n\",n().createElement(l.pre,null,n().createElement(l.code,{className:\"language-shell\",display:\"block\"},\"SECRET=/secret/macstadium/orka/ORKV10000025\\nvault read -field password $SECRET | \\\\\\n  sudo openconnect \\\\\\n    --user=$(vault read -field username $SECRET) \\\\\\n    --passwd-on-stdin \\\\\\n    --servercert  $(vault read -field servercert $SECRET) \\\\\\n    $(vault read -field server_address $SECRET)\\n\")),\"\\n\",n().createElement(l.p,null,\"If you are not on Linux or Mac, or would rather use a different\\ninterface for connecting, there are instructions available in the\\nMacStadium documentation, above.\"),\"\\n\",n().createElement(l.h2,{id:\"adding-orka-to-a-jenkins-controller\"},\"Adding Orka to a Jenkins controller\"),\"\\n\",n().createElement(l.p,null,\"The high level process describe below is as follows:\"),\"\\n\",n().createElement(l.ul,null,\"\\n\",n().createElement(l.li,null,\"Create new user and allocate nodes\"),\"\\n\",n().createElement(l.li,null,\"Manually set up Jenkins and test connection\"),\"\\n\",n().createElement(l.li,null,\"Update Vault and commit config changes to Git so they're available\\nduring updates.\"),\"\\n\"),\"\\n\",n().createElement(l.h3,{id:\"create-an-orka-user\"},\"Create an Orka User\"),\"\\n\",n().createElement(l.ol,null,\"\\n\",n().createElement(l.li,null,\"\\n\",n().createElement(l.p,null,\"Connect to the Orka VPN and log into Orka\"),\"\\n\"),\"\\n\",n().createElement(l.li,null,\"\\n\",n().createElement(l.p,null,\"Use \",n().createElement(l.code,{display:\"inline\"},\"orka user create\"),\" to create a new user for the cluster.\"),\"\\n\",n().createElement(l.pre,null,n().createElement(l.code,{className:\"language-shell\",display:\"block\"},\"export JENKINS_NAME=foo-ci\\norka user create -e infra-root+orka-${JENKINS_NAME}@elastic.co\\n\")),\"\\n\"),\"\\n\",n().createElement(l.li,null,\"\\n\",n().createElement(l.p,null,\"Fill in a secure password (don't lose it, we'll add it to Vault soon)\"),\"\\n\"),\"\\n\",n().createElement(l.li,null,\"\\n\",n().createElement(l.p,null,\"Assign the new user to a group with \",n().createElement(l.code,{display:\"inline\"},\"orka user group\")),\"\\n\",n().createElement(l.pre,null,n().createElement(l.code,{className:\"language-shell\",display:\"block\"},\"orka user group -e infra-root+orka-${JENKINS_NAME}@elastic.co -g ${JENKINS_NAME}\\n\")),\"\\n\"),\"\\n\"),\"\\n\",n().createElement(l.h4,{id:\"assign-orka-nodes\"},\"Assign Orka Nodes\"),\"\\n\",n().createElement(l.p,null,\"We divide the total number of Okra nodes across the teams that have\\naccess to Orka.  This allows us to manage a single Orka cluster but\\nprovide separate pools of workers for our customers.  Putting it a\\ndifferent way, we allocate and dedicate resources to different teams\\nso they always have the capacity they expect.\"),\"\\n\",n().createElement(l.ol,null,\"\\n\",n().createElement(l.li,null,\"\\n\",n().createElement(l.p,null,\"Get the list of nodes intended for the new team (this was likely\\nprovided in an earlier request for more capacity)\"),\"\\n\"),\"\\n\",n().createElement(l.li,null,\"\\n\",n().createElement(l.p,null,\"Use \",n().createElement(l.code,{display:\"inline\"},\"orka node group\"),\" to assign a node to a group.  The group\\nshould be the same one as used above when calling \",n().createElement(l.code,{display:\"inline\"},\"orka user group\"),\".  Use \",n().createElement(l.code,{display:\"inline\"},\"orka node list\"),\" to check the node names to use.\"),\"\\n\",n().createElement(l.pre,null,n().createElement(l.code,{className:\"language-shell\",display:\"block\"},\"orka node group -g ${JENKINS_NAME} -n <Node Name Here>\\n\")),\"\\n\"),\"\\n\"),\"\\n\",n().createElement(l.h3,{id:\"set-up-jenkins\"},\"Set Up Jenkins\"),\"\\n\",n().createElement(l.h4,{id:\"add-jenkins-credentials\"},\"Add Jenkins credentials\"),\"\\n\",n().createElement(l.p,null,\"To add a new credential, go to the Jenkins controller and click\\n\",n().createElement(l.code,{display:\"inline\"},\"Manage Jenkins\"),\" > \",n().createElement(l.code,{display:\"inline\"},\"Manage Credentials\"),\" > \",n().createElement(l.code,{display:\"inline\"},\"(global)\"),\" > \",n().createElement(l.code,{display:\"inline\"},\"Add Credentials\")),\"\\n\",n().createElement(l.p,null,\"The URL will look like this page for\\n\",n().createElement(l.a,{href:\"https://plumbers-ci.elastic.co/credentials/store/system/domain/_/newCredentials\"},\"plumbers-ci\"),\".\"),\"\\n\",n().createElement(l.p,null,n().createElement(l.strong,null,\"Plugin credentials\")),\"\\n\",n().createElement(l.p,null,\"This credential is for connecting to the Orka cluster itself (i.e. for\\norchestration).\"),\"\\n\",n().createElement(l.table,null,n().createElement(l.thead,null,n().createElement(l.tr,null,n().createElement(l.th,null,\"Field\"),n().createElement(l.th,null,\"Value\"))),n().createElement(l.tbody,null,n().createElement(l.tr,null,n().createElement(l.td,null,\"Kind\"),n().createElement(l.td,null,\"Username with password\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"Username\"),n().createElement(l.td,null,\"(the email address of the newly created user, above)\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"Treat username as secret\"),n().createElement(l.td,null,\"checked\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"Password\"),n().createElement(l.td,null,\"(the password for the newly created user, above)\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"ID\"),n().createElement(l.td,null,\"orka-plugin-creds\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"Description\"),n().createElement(l.td,null,\"Creds for the Orka plugin\")))),\"\\n\",n().createElement(l.p,null,n().createElement(l.strong,null,\"Agent SSH credentials\")),\"\\n\",n().createElement(l.p,null,\"This credential is to inform the plugin how to SSH to the ephemeral\\nVM.\"),\"\\n\",n().createElement(l.p,null,\"Look up the value for the username and password from vault via:\"),\"\\n\",n().createElement(l.pre,null,n().createElement(l.code,{className:\"language-shell\",display:\"block\"},\"vault read secret/ci-systems/orka/default-ssh-credentials \\n\")),\"\\n\",n().createElement(l.table,null,n().createElement(l.thead,null,n().createElement(l.tr,null,n().createElement(l.th,null,\"Field\"),n().createElement(l.th,null,\"Value\"))),n().createElement(l.tbody,null,n().createElement(l.tr,null,n().createElement(l.td,null,\"Kind\"),n().createElement(l.td,null,\"Username with password\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"Username\"),n().createElement(l.td,null,\"admin\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"Treat username as secret\"),n().createElement(l.td,null,\"checked\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"Password\"),n().createElement(l.td,null,\"(see above)\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"ID\"),n().createElement(l.td,null,\"orka-vm-ssh-creds\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"Description\"),n().createElement(l.td,null,\"Orka agent ssh credentials\")))),\"\\n\",n().createElement(l.h4,{id:\"jenkins-plugin-setup\"},\"Jenkins plugin setup\"),\"\\n\",n().createElement(l.p,null,'Ensure the plugin is installed by searching for \"Orka\" in the Plugin\\nManager.  Got to ',n().createElement(l.code,{display:\"inline\"},\"Manage Jenkins\"),\" > \",n().createElement(l.code,{display:\"inline\"},\"Manage Plugins\"),\" > \",n().createElement(l.code,{display:\"inline\"},\"Installed\"),' and\\nsearch the page for \"Orka\".'),\"\\n\",n().createElement(l.p,null,\"Assuming the plugin is installed, there will be a new option on\\nthe Configure Clouds screen at \",n().createElement(l.code,{display:\"inline\"},\"Manage Jenkins\"),\" > \",n().createElement(l.code,{display:\"inline\"},\"Manage Nodes and Clouds\"),\" > \",n().createElement(l.code,{display:\"inline\"},\"Configure Clouds\"),\".\"),\"\\n\",n().createElement(l.p,null,\"Click \",n().createElement(l.code,{display:\"inline\"},\"Add a new cloud\"),\" and select \",n().createElement(l.code,{display:\"inline\"},\"Orka Cloud\"),\".\"),\"\\n\",n().createElement(l.table,null,n().createElement(l.thead,null,n().createElement(l.tr,null,n().createElement(l.th,null,\"Field\"),n().createElement(l.th,null,\"Value\"))),n().createElement(l.tbody,null,n().createElement(l.tr,null,n().createElement(l.td,null,\"Name of this Cloud\"),n().createElement(l.td,null,\"MacStadium Orka\")),n().createElement(l.tr,null,n().createElement(l.td,null,\"Orka Credentials\"),n().createElement(l.td,null,\"(select \",n().createElement(l.code,{display:\"inline\"},\"Creds for the Orka plugin\"))),n().createElement(l.tr,null,n().createElement(l.td,null,\"Orka Endpoint\"),n().createElement(l.td,null,n().createElement(l.a,{href:\"http://10.221.188.100\"},\"http://10.221.188.100\"))))),\"\\n\",n().createElement(l.p,null,\"Hit \",n().createElement(l.code,{display:\"inline\"},\"Test Connection\"),\" to see if the credential works.  If it doesn't,\\ntry logging into Orka with the email and password generated above and\\ndouble checking that those fields were copied and pasted correctly\\ninto the Jenkins UI.\"),\"\\n\",n().createElement(l.h4,{id:\"add-a-new-jenkins-administrator\"},\"Add a new Jenkins administrator\"),\"\\n\",n().createElement(l.p,null,\"There should have been a GitHub issue requesting access to Orka that\\npreceded this work and, as part of that, a member of the client team\\nshould have been identified as the person responsible for\\nadministering the Orka images.  Go to \",n().createElement(l.code,{display:\"inline\"},\"Manage Jenkins\"),\" > \",n().createElement(l.code,{display:\"inline\"},\"Configure Global Security\"),\" and add that user to the list of users under the\\n\",n().createElement(l.code,{display:\"inline\"},\"Authorization\"),\" header.  Select \",n().createElement(l.code,{display:\"inline\"},\"Administer\"),\" under permissions.  Click\\n\",n().createElement(l.code,{display:\"inline\"},\"Save\"),\".\"),\"\\n\",n().createElement(l.h3,{id:\"reflect-changes-in-ansible\"},\"Reflect Changes in Ansible\"),\"\\n\",n().createElement(l.p,null,\"Double and triple check these values as you won't know you've gotten\\nit wrong until during a Jenkins party.\"),\"\\n\",n().createElement(l.h4,{id:\"write-secrets-to-vault\"},\"Write Secrets to Vault\"),\"\\n\",n().createElement(l.p,null,\"First we need to encrypt the passwords used in the credentials above.\\nLog into a Jenkins controller and go to \",n().createElement(l.code,{display:\"inline\"},\"Manage Jenkins\"),\" > \",n().createElement(l.code,{display:\"inline\"},\"Script Console\"),\" and copy the following into the text area.  Replace\\n\",n().createElement(l.code,{display:\"inline\"},\"<secret>\"),\" with each value and hit \",n().createElement(l.code,{display:\"inline\"},\"Run\"),\".  Note the encrypted values.\"),\"\\n\",n().createElement(l.pre,null,n().createElement(l.code,{className:\"language-groovy\",display:\"block\"},'import hudson.util.Secret;\\nString toEncrypt = \"<secret>\"\\nSecret secret = Secret.fromString(toEncrypt)\\nprint secret.getEncryptedValue();\\n')),\"\\n\",n().createElement(l.p,null,\"Fill in the values for the plain text and encrypted values below and run:\"),\"\\n\",n().createElement(l.pre,null,n().createElement(l.code,{className:\"language-shell\",display:\"block\"},'export JENKINS_NAME=foo-ci\\nvault write secret/ansible/dev/${JENKINS_NAME}/jenkins_orka_plugin_user value=\"infra-root+orka-${JENKINS_NAME}@elastic.co\"\\nvault write /secret/ansible/dev/jenkins_encrypted/${JENKINS_NAME}/jenkins_orka_plugin_password plaintext=\"...\" encrypted=\"...\"\\nvault write secret/ansible/prod/${JENKINS_NAME}/jenkins_orka_plugin_user value=\"infra-root+orka-${JENKINS_NAME}@elastic.co\"\\nvault write /secret/ansible/prod/jenkins_encrypted/${JENKINS_NAME}/jenkins_orka_plugin_password plaintext=\"...\" encrypted=\"...\"\\n')),\"\\n\",n().createElement(l.pre,null,n().createElement(l.code,{className:\"language-shell\",display:\"block\"},'export JENKINS_NAME=foo-ci\\nvault write secret/ansible/dev/jenkins_encrypted/beats-ci/jenkins_orka_vm_ssh_password plaintext=\"...\" encrypted=\"...\"\\nvault write secret/ansible/prod/jenkins_encrypted/beats-ci/jenkins_orka_vm_ssh_password plaintext=\"...\" encrypted=\"...\"\\n')),\"\\n\",n().createElement(l.h4,{id:\"ansible-changes\"},\"Ansible changes\"),\"\\n\",n().createElement(l.p,null,\"There are several changes needed to make this permanent.  Here is a\\nlist along with links to examples in a GitHub Pull Request:\"),\"\\n\",n().createElement(l.ul,null,\"\\n\",n().createElement(l.li,null,n().createElement(l.a,{href:\"https://github.com/elastic/infra/pull/36011/files#diff-b748831ba3d496fd280ecbafb7c191a546086168839fe185a0f57966a5759123R7-R10\"},\"Add the new Jenkins admin\")),\"\\n\",n().createElement(l.li,null,n().createElement(l.a,{href:\"https://github.com/elastic/infra/pull/36011/files#diff-b748831ba3d496fd280ecbafb7c191a546086168839fe185a0f57966a5759123R94-R95\"},\"Ansible group_vars for the controller\")),\"\\n\",n().createElement(l.li,null,\"Ansible host_vars, \",n().createElement(l.a,{href:\"https://github.com/elastic/infra/pull/36011/files#diff-d7eebe3442953412db0506918d59f7f807ea68ee873eb0067674211c552626c5R9-R10\"},\"blue\"),\" and \",n().createElement(l.a,{href:\"https://github.com/elastic/infra/pull/36011/files#diff-2f81777976c559fc912eaad79322e7dfbba8d3f67ec3eb423c1427090a72f291R9-R10\"},\"green\")),\"\\n\",n().createElement(l.li,null,\"Jenkins config.xml in Ansible - For this one, SSH into the controller and look at \",n().createElement(l.code,{display:\"inline\"},\"/var/lib/jenkins/config.xml\"),\" to get the real value.  Look for the section for \",n().createElement(l.code,{display:\"inline\"},\"io.jenkins.plugins.orka.OrkaCloud\"),\" and insert it into the template \",n().createElement(l.a,{href:\"https://github.com/elastic/infra/blob/e52eb809e59f21701834116982856add962b0bde/ansible/roles/jenkins/templates/config.xml.j2#L2018-L2111\"},\"similer to this\"),\".\"),\"\\n\",n().createElement(l.li,null,n().createElement(l.a,{href:\"https://github.com/elastic/infra/pull/36011/files#diff-8b3914a6593682de1192f503b35d9607c3263f9af022fbaf7ff02da43cc0ab33R83-R98\"},\"Jenkins credentials\")),\"\\n\"),\"\\n\",n().createElement(l.h3,{id:\"testing\"},\"Testing\"),\"\\n\",n().createElement(l.p,null,\"Aside from \",n().createElement(l.code,{display:\"inline\"},\"Test Connection\"),\" there isn't much we do.  Work with the\\nOrka user on the customer team to ensure they have what they need to\\ncreate a node and be available to help them debug should something go\\nwrong.\"))}}})(),r})()));","frontmatter":{"id":"macstadiumOrkaAdministration","slug":"/ci/macstadium/orka_administration","title":"Orka Administration","summary":"Admin guide for CI Systems engineers","date":"2022-05-17T00:00:00.000Z","tags":["ci","ci/cd","macos","orka","developer tools","engineering","platform"],"link":"https://github.com/elastic/ci/blob/main","linkPath":"docs/macstadium/orka_administration.mdx"},"missionId":"krVideos"},"__N_SSG":true}