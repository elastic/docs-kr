{"pageProps":{"bundle":"!function(e,t){\"object\"==typeof exports&&\"object\"==typeof module?module.exports=t(require(\"mdxJsReact\"),require(\"React\")):\"function\"==typeof define&&define.amd?define([\"mdxJsReact\",\"React\"],t):\"object\"==typeof exports?exports.MDXContent=t(require(\"mdxJsReact\"),require(\"React\")):e.MDXContent=t(e.mdxJsReact,e.React)}(this,((e,t)=>(()=>{\"use strict\";var n={24:e=>{e.exports=t},825:t=>{t.exports=e}},a={};function l(e){var t=a[e];if(void 0!==t)return t.exports;var r=a[e]={exports:{}};return n[e](r,r.exports,l),r.exports}l.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return l.d(t,{a:t}),t},l.d=(e,t)=>{for(var n in t)l.o(t,n)&&!l.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},l.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),l.r=e=>{\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})};var r={};return(()=>{l.r(r),l.d(r,{default:()=>a});var e=l(825),t=l(24),n=l.n(t);const a=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a=Object.assign({},(0,e.useMDXComponents)(),t.components),l=a.wrapper;return l?n().createElement(l,t,n().createElement(r)):r();function r(){var a=Object.assign({p:\"p\",h2:\"h2\",h3:\"h3\",a:\"a\",ol:\"ol\",li:\"li\",blockquote:\"blockquote\",table:\"table\",thead:\"thead\",tr:\"tr\",th:\"th\",tbody:\"tbody\",td:\"td\"},(0,e.useMDXComponents)(),t.components);return n().createElement(n().Fragment,null,n().createElement(a.p,null,'Orka stands for \"Orchestration with Kubernetes on Apple\" and is the\\nproduct we use to provide ephemeral nodes for CI.'),\"\\n\",n().createElement(a.h2,{id:\"how-does-orka-work-at-elastic\"},\"How does Orka work at Elastic?\"),\"\\n\",n().createElement(a.p,null,\"Orka is not a cloud in the sense that it can scale capacity up and\\ndown.  We must purchase a number of nodes on which Orka can launch\\nvirtual Mac machines.  We have purchased a number of nodes and then\\nassigned them to specific teams for use.\"),\"\\n\",n().createElement(a.p,null,\"Each team that needs access to Orka will work with the CI Systems team\\nto gain access.\"),\"\\n\",n().createElement(a.p,null,\"On Jenkins we use the MacStadium Orka plugin for Jenkins to provision\\nworkers when a job needs them.\"),\"\\n\",n().createElement(a.h3,{id:\"initial-setup\"},\"Initial setup\"),\"\\n\",n().createElement(a.p,null,\"In order to get started with Orka a member of your team will be\\ndesignated and granted access to the MacStadium firewall and Orka\\ncluster.  This person will be able to use the \",n().createElement(a.a,{href:\"\"},\"Orka CLI\"),\" to\\nprovision new VMs and create new images that can be used with CI.\"),\"\\n\",n().createElement(a.ol,null,\"\\n\",n().createElement(a.li,null,'Decide who on your team will be responsible for images.  For the\\npurposes of discussion, I will refer to them as \"the Orka user\".\\nThis person will be responsible for creating and provisioning the\\nimages.  Typically this is a periodic event depending on how\\nup-to-date you want to keep your images.'),\"\\n\",n().createElement(a.li,null,n().createElement(a.a,{href:\"https://github.com/elastic/ci/issues/new\"},\"Open a ticket\"),\"\\nrequesting access to Orka for the Orka user.\"),\"\\n\",n().createElement(a.li,null,\"Once an account is created the firewall credentials will be shared\\nwith the Orka user and they will need to \",n().createElement(a.a,{href:\"https://orkadocs.macstadium.com/docs/vpn-connect\"},\"set up a VPN\\nclient\"),\".\"),\"\\n\"),\"\\n\",n().createElement(a.h3,{id:\"image-management\"},\"Image management\"),\"\\n\",n().createElement(a.blockquote,null,\"\\n\",n().createElement(a.p,null,\"OPEN QUESTION: the below assumes a single member of a team is\\nappointed as a privileged user.  This serves 2 purposes.\"),\"\\n\",n().createElement(a.ol,null,\"\\n\",n().createElement(a.li,null,\"it limits access to a smaller set of known individuals.\"),\"\\n\",n().createElement(a.li,null,\"it reduces the burden of dealing with the MacStadium firewall\\n(i.e. number of folks sharing the creds, or number of creds to\\nmanually manage via the awful java webstart applet.\"),\"\\n\"),\"\\n\",n().createElement(a.p,null,\"The other option might be to provide a bastion for Orka access.  I\\nthink it is a better long-term solution but it may be something we\\ncan defer for now.  I wanted to mention it just in case someone had\\nStrong Feelings regarding it.\"),\"\\n\"),\"\\n\",n().createElement(a.p,null,\"Images are created and managed by the Orka user.  CI Systems does not\\nprovide images.  Orka does come with base images for various Mac OS\\nversions, but adding test dependencies, Docker, user accounts,\\netc. are all up to the Orka user.\"),\"\\n\",n().createElement(a.p,null,\"The Orka user will be granted elevated privileges to Jenkins, as well,\\nso they can iterate both on image creation, but also the image\\ndefinition in Jenkins.\"),\"\\n\",n().createElement(a.h2,{id:\"orka-operations\"},\"Orka Operations\"),\"\\n\",n().createElement(a.p,null,\"Members of CI Systems have administrative access to Orka and can\\nperform some tasks when needed.  For example, killing a VM that is\\nstuck.\"),\"\\n\",n().createElement(a.p,null,\"MacStadium operates the cluster and we can work with them for scaling\\nand support purposes.\"),\"\\n\",n().createElement(a.h3,{id:\"how-have-we-allocated-orka-nodes\"},\"How have we allocated Orka nodes?\"),\"\\n\",n().createElement(a.p,null,\"We currently have Orka nodes available for Endgame CI, Beats CI, APM\\nCI, and Fleet CI:\"),\"\\n\",n().createElement(a.table,null,n().createElement(a.thead,null,n().createElement(a.tr,null,n().createElement(a.th,null,\"Team\"),n().createElement(a.th,null,\"Intel Macs\"),n().createElement(a.th,null,\"Apple Silicon Macs\"))),n().createElement(a.tbody,null,n().createElement(a.tr,null,n().createElement(a.td,null,\"Endpoint\"),n().createElement(a.td,null,\"7\"),n().createElement(a.td,null,\"1\")),n().createElement(a.tr,null,n().createElement(a.td,null,\"Observability\"),n().createElement(a.td,null,\"2\"),n().createElement(a.td,null,\"2\")))),\"\\n\",n().createElement(a.h3,{id:\"how-do-we-monitor-orka\"},\"How do we monitor Orka?\"),\"\\n\",n().createElement(a.p,null,\"We are researching ways to monitor Orka in a way that will\\nnot impact performance or capacity.  Since we are not launching nodes\\nwith gobld, some of our usual mechanisms don't apply.\"),\"\\n\",n().createElement(a.ol,null,\"\\n\",n().createElement(a.li,null,\"Alerts for low space available on the SAN\"),\"\\n\",n().createElement(a.li,null,\"(Future) Use CI/CD Observability to detect stuck jobs\"),\"\\n\",n().createElement(a.li,null,\"(Future) Periodically call the Orka CLI to monitor status\"),\"\\n\",n().createElement(a.li,null,\"(Future) Periodically pull the Orka server logs and index into CI-Stats\"),\"\\n\"),\"\\n\",n().createElement(a.p,null,\"Some potential solutions may impact performance or capacity, but are\\nlisted here for completeness:\"),\"\\n\",n().createElement(a.ol,null,\"\\n\",n().createElement(a.li,null,\"Periodically run a short heartbeat job to ensure jobs are running\\nto completion on Mac workers.\"),\"\\n\",n().createElement(a.li,null,\"Install standard Beats on Orka controllers.\"),\"\\n\"),\"\\n\",n().createElement(a.p,null,\"Finally, MacStadium is working on adding a Prometheus endpoint to Orka\\nand we will add that data to CI-Stats once it is available.\"))}}})(),r})()));","frontmatter":{"id":"macstadiumOrka","slug":"/ci/macstadium/orka","title":"MacStadium Orka","summary":"How we provide ephemeral Mac workers for CI","date":"2022-05-16T00:00:00.000Z","tags":["ci","ci/cd","macos","orka","developer tools","engineering","platform"],"link":"https://github.com/elastic/ci/blob/main","linkPath":"docs/macstadium/orka.mdx"},"missionId":"krVideos"},"__N_SSG":true}