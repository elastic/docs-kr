<!DOCTYPE html><html lang="en"><head><meta name="eui-styles"/><script async="" src="https://www.googletagmanager.com/gtag/js?id=UA-12395217-24"></script><script>
              window.dataLayer = window.dataLayer || [];
              function gtag(){dataLayer.push(arguments);}
              gtag('js', new Date());
              gtag('config', 'UA-12395217-24', {
                page_path: window.location.pathname,
              });
          </script><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><script>!function(){try{var d=document.documentElement;var e=localStorage.getItem("elastic-docs-theme");if(e){d.setAttribute('data-theme', e)}else{d.setAttribute('data-theme', 'light');}}catch(t){}}();</script><title>Design | Elastic Documentation</title><meta property="og:title" content="Design | Elastic Documentation"/><meta class="elastic" name="title" content="Design"/><meta class="elastic" name="date" content="2022-03-28T00:00:00.000Z"/><meta name="description" content="Need help? Here you&#x27;ll find complete coverage of Elasticsearch, Kibana and more."/><meta property="og:description" content="Need help? Here you&#x27;ll find complete coverage of Elasticsearch, Kibana and more."/><meta name="twitter:site" content="@elastic"/><meta property="og:url" content="http://localhost:3000/ci/gobld/design"/><link rel="stylesheet" type="text/css" href="/themes/eui_theme_undefined.min.css"/><link rel="stylesheet" type="text/css" href="/themes/theme_undefined.css"/><link rel="shortcut icon" href="/assets/images/favicon.ico"/><meta name="next-head-count" content="14"/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-a40ef1678bae11e696dba45124eadd70.js"></script><script src="/_next/static/chunks/webpack-5b19eee634f155d9037d.js" defer=""></script><script src="/_next/static/chunks/framework-bf9b12c23e794b196495.js" defer=""></script><script src="/_next/static/chunks/main-710a14204f294c81ed08.js" defer=""></script><script src="/_next/static/chunks/pages/_app-d9a28ac2b5165b299106.js" defer=""></script><script src="/_next/static/chunks/c78d26b1-ff6470003369f2a26fc7.js" defer=""></script><script src="/_next/static/chunks/103-fd3e1552f32e8c4a6b92.js" defer=""></script><script src="/_next/static/chunks/3674-41861bc71d856d154d9e.js" defer=""></script><script src="/_next/static/chunks/7815-952dc762df3d4a43befe.js" defer=""></script><script src="/_next/static/chunks/9237-e960f47bcd4625ef5949.js" defer=""></script><script src="/_next/static/chunks/4620-e195c3f5ae7ecefc57c7.js" defer=""></script><script src="/_next/static/chunks/8482-a7f4dd7850e2aa9b7794.js" defer=""></script><script src="/_next/static/chunks/pages/%5B...slug%5D-ac753ff46f79468d535c.js" defer=""></script><script src="/_next/static/AzE3g5BBfFWf9aUdpqGZ7/_buildManifest.js" defer=""></script><script src="/_next/static/AzE3g5BBfFWf9aUdpqGZ7/_ssgManifest.js" defer=""></script></head><body class="guideBody"><div id="__next"><div class="docWrapper"><header data-elastic-exclude="true"><div class="euiHeader euiHeader--dark euiHeader--fixed"><div class="euiHeaderSection euiHeaderSection--dontGrow euiHeaderSection--left"><div class="euiHeaderSectionItem"><a rel="noreferrer" class="euiHeaderLogo"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--large euiIcon-isLoading euiHeaderLogo__icon" focusable="false" role="img" aria-label="Elastic" aria-hidden="true"></svg><span class="euiHeaderLogo__text"><svg class="elasticMark" width="64" height="19" fill="white" xmlns="http://www.w3.org/2000/svg" aria-labelledby="elasticMark"><title id="elasticMark">Elastic</title><path d="M9.74 16.882l.711-.076.046 1.455c-1.879.257-3.485.393-4.818.393-1.773 0-3.03-.515-3.773-1.545C1.164 16.08.8 14.473.8 12.306c0-4.333 1.727-6.5 5.167-6.5 1.666 0 2.909.47 3.727 1.394.818.924 1.227 2.394 1.227 4.379l-.106 1.409H2.664c0 1.364.242 2.379.742 3.03.5.652 1.349.985 2.576.985 1.242.03 2.485-.015 3.757-.121zm-.667-5.349c0-1.515-.243-2.59-.728-3.212-.484-.621-1.272-.94-2.363-.94s-1.924.334-2.47.986c-.545.651-.833 1.712-.848 3.166h6.409zM13.497 18.427V.7h1.848v17.727h-1.848zM27.027 9.806v6.076c0 .621 1.53.742 1.53.742l-.09 1.637c-1.303 0-2.38.106-3.03-.515a10.861 10.861 0 01-4.44.924c-1.136 0-2-.319-2.59-.97-.592-.636-.895-1.56-.895-2.773 0-1.197.303-2.09.91-2.651.605-.56 1.56-.925 2.863-1.046l3.879-.363v-1.06c0-.834-.182-1.44-.546-1.804-.363-.364-.863-.545-1.485-.545H18.27V5.82h4.742c1.394 0 2.41.318 3.046.97.651.636.97 1.651.97 3.015zm-7.606 5.03c0 1.516.621 2.273 1.879 2.273a9.89 9.89 0 003.303-.56l.56-.197v-4.076l-3.65.348c-.743.06-1.274.273-1.607.637-.333.363-.485.894-.485 1.575zM34.255 7.473c-1.788 0-2.697.62-2.697 1.879 0 .575.212.984.62 1.227.41.242 1.35.485 2.819.742 1.47.258 2.5.606 3.106 1.076.606.454.91 1.318.91 2.59 0 1.274-.41 2.198-1.228 2.789-.818.59-2 .894-3.576.894-1.015 0-4.424-.38-4.424-.38l.106-1.605c1.954.182 3.379.333 4.333.333.955 0 1.682-.151 2.182-.454.5-.303.758-.819.758-1.53 0-.713-.212-1.198-.637-1.455-.424-.258-1.363-.5-2.818-.728-1.455-.227-2.485-.56-3.09-1.015-.607-.439-.91-1.272-.91-2.47 0-1.196.424-2.09 1.273-2.666.848-.576 1.909-.864 3.166-.864 1 0 4.485.258 4.485.258v1.621c-1.833-.106-3.333-.242-4.379-.242zM47.952 7.685h-3.925v5.909c0 1.409.106 2.348.303 2.788.212.44.697.666 1.47.666l2.197-.151.121 1.53c-1.106.182-1.94.273-2.515.273-1.288 0-2.167-.318-2.667-.94-.5-.62-.742-1.818-.742-3.575v-6.5h-1.758V6.079h1.758V2.29h1.833v3.773h3.925v1.62zM50.527 3.276V1.139h1.849v2.152l-1.849-.015zm0 15.151V6.08h1.849v12.348h-1.849zM60.406 5.821c.546 0 1.47.106 2.773.303l.59.076-.075 1.5c-1.318-.152-2.288-.227-2.91-.227-1.393 0-2.348.333-2.848 1-.5.666-.757 1.909-.757 3.712 0 1.803.227 3.06.697 3.773.47.712 1.44 1.06 2.924 1.06l2.91-.227.075 1.53c-1.53.227-2.682.349-3.44.349-1.924 0-3.257-.5-3.984-1.485-.728-.985-1.106-2.652-1.106-5 0-2.349.393-4 1.181-4.94.803-.939 2.122-1.424 3.97-1.424z"></path></svg></span></a></div></div><div class="euiHeaderSection euiHeaderSection--dontGrow euiHeaderSection--left"><div class="euiHeaderSectionItem"><nav class="euiHeaderLinks" aria-label="App menu"><div class="euiHeaderLinks__list euiHeaderLinks__list--gutterS"><a class="euiButton euiButton--primary euiButton--small euiButton--fill" href="https://cloud.elastic.co/registration?source=docsHeader" rel=""><span class="euiButtonContent euiButton__content"><span class="euiButton__text">Try Free</span></span></a></div></nav></div></div></div></header><div class="euiPage euiPage--grow docArticle__template"><div class="euiPageSideBar euiPageSideBar--paddingLarge euiPageSideBar--sticky docChrome__sidebar"><div class="euiFlexItem" data-elastic-exclude="true"><div class="euiContextMenu docChrome__contextMenu"><div class="euiContextMenuPanel euiContextMenu__panel" tabindex="-1"><button class="euiContextMenuPanelTitle" type="button" data-test-subj="contextMenuPanelTitleButton"><span class="euiContextMenu__itemLayout"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading euiContextMenu__icon" focusable="false" role="img" aria-hidden="true"></svg><span class="euiContextMenu__text">Elastic 영상 모음</span></span></button><div><style data-emotion="css i2qclb-euiSpacer-s">.css-i2qclb-euiSpacer-s{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;height:8px;}</style><div class="euiSpacer euiSpacer--s css-i2qclb-euiSpacer-s"></div><nav class="euiSideNav" aria-label="Elastic 영상 모음"><div id="euiSideNav_b951d2d0-eaaa-11ec-a345-914ba1e53e00_content" class="euiSideNav__content euiSideNav__contentMobile-xs euiSideNav__contentMobile-s"><div class="euiSideNavItem euiSideNavItem--root euiSideNavItem--hasChildItems"><div class="euiSideNavItemButton"><span class="euiSideNavItemButton__content"><span class="euiSideNavItemButton__label euiSideNavItemButton__label--truncated">Elastic 영상 모음</span></span></div><div class="euiSideNavItem__items"><div class="euiSideNavItem euiSideNavItem--trunk"><a class="euiSideNavItemButton euiSideNavItemButton--isClickable" href="/krVideos/overview" rel="noreferrer"><span class="euiSideNavItemButton__content"><span class="euiSideNavItemButton__label euiSideNavItemButton__label--truncated">페이지 소개</span></span></a></div></div></div><div class="euiSideNavItem euiSideNavItem--root euiSideNavItem--hasChildItems"><div class="euiSideNavItemButton"><span class="euiSideNavItemButton__content"><span class="euiSideNavItemButton__label euiSideNavItemButton__label--truncated">데이터 수집 및 시각화 데모</span></span></div><div class="euiSideNavItem__items"><div class="euiSideNavItem euiSideNavItem--trunk"><a class="euiSideNavItemButton euiSideNavItemButton--isClickable" href="/krVideos/vid-seoulMetro2019" rel="noreferrer"><span class="euiSideNavItemButton__content"><span class="euiSideNavItemButton__label euiSideNavItemButton__label--truncated">(2019) 서울시 지하철 대시보드 만들기</span></span></a></div></div></div><div class="euiSideNavItem euiSideNavItem--root euiSideNavItem--hasChildItems"><div class="euiSideNavItemButton"><span class="euiSideNavItemButton__content"><span class="euiSideNavItemButton__label euiSideNavItemButton__label--truncated">(2021) 처음부터 시작하는 Elastic</span></span></div><div class="euiSideNavItem__items"><div class="euiSideNavItem euiSideNavItem--trunk"><a class="euiSideNavItemButton euiSideNavItemButton--isClickable" href="/krVideos/vid-esScratch2021-0" rel="noreferrer"><span class="euiSideNavItemButton__content"><span class="euiSideNavItemButton__label euiSideNavItemButton__label--truncated">0. 과정 소개 및 시스템 준비</span></span></a></div><div class="euiSideNavItem euiSideNavItem--trunk"><a class="euiSideNavItemButton euiSideNavItemButton--isClickable" href="/krVideos/vid-esScratch2021-1" rel="noreferrer"><span class="euiSideNavItemButton__content"><span class="euiSideNavItemButton__label euiSideNavItemButton__label--truncated">1. Stack 설치 및 환경 설정</span></span></a></div><div class="euiSideNavItem euiSideNavItem--trunk"><a class="euiSideNavItemButton euiSideNavItemButton--isClickable" href="/krVideos/vid-esScratch2021-2" rel="noreferrer"><span class="euiSideNavItemButton__content"><span class="euiSideNavItemButton__label euiSideNavItemButton__label--truncated">2. 데이터 활용 및 QueryDSL</span></span></a></div><div class="euiSideNavItem euiSideNavItem--trunk"><a class="euiSideNavItemButton euiSideNavItemButton--isClickable" href="/krVideos/vid-esScratch2021-3" rel="noreferrer"><span class="euiSideNavItemButton__content"><span class="euiSideNavItemButton__label euiSideNavItemButton__label--truncated">3. 데이터 파이프라인 구성</span></span></a></div><div class="euiSideNavItem euiSideNavItem--trunk"><a class="euiSideNavItemButton euiSideNavItemButton--isClickable" href="/krVideos/vid-esScratch2021-4" rel="noreferrer"><span class="euiSideNavItemButton__content"><span class="euiSideNavItemButton__label euiSideNavItemButton__label--truncated">4. Kibana 대시보드 만들기</span></span></a></div></div></div></div></nav></div></div></div></div></div><div class="euiPanel euiPanel--paddingLarge euiPanel--borderRadiusNone euiPanel--plain euiPanel--hasShadow euiPageBody euiPageBody--borderRadiusNone euiPageBody--paddingLarge"><div class="euiFlexGroup euiFlexGroup--gutterExtraLarge euiFlexGroup--directionRow euiFlexGroup--responsive docArticle__wrap"><div class="euiFlexItem docArticle__article"><header class="euiPageHeader euiPageHeader--bottomBorder euiPageHeader--responsive euiPageHeader--center"><div class="euiPageHeaderContent"><div class="euiFlexGroup euiFlexGroup--gutterLarge euiFlexGroup--alignItemsFlexStart euiFlexGroup--directionRow euiFlexGroup--responsive euiPageHeaderContent__top"><div class="euiFlexItem"><h1 class="euiTitle euiTitle--large">Design</h1><style data-emotion="css jz428s-euiSpacer-l">.css-jz428s-euiSpacer-l{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;height:24px;}</style><div class="euiSpacer euiSpacer--l css-jz428s-euiSpacer-l"></div><div class="euiText euiText--medium euiText--constrainedWidth"><p><span class="euiTextColor euiTextColor--subdued"></span></p></div></div></div></div></header><style data-emotion="css kiiy9t-euiSpacer-xl">.css-kiiy9t-euiSpacer-xl{-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;height:32px;}</style><div class="euiSpacer euiSpacer--xl css-kiiy9t-euiSpacer-xl"></div><div class="euiPanel euiPanel--borderRadiusMedium euiPanel--plain euiPanel--noShadow euiPageContent" role="main"><div class="euiPageContentBody"><div class="euiText euiText--medium"><p>The design goal of Gobld is to be stateless and as simple as possible.</p>
<p>Webhook events are received via an API call from the Buildkite notification service and initially placed on an in-memory event queue.<br/>
<!-- -->An internal loop then pulls events from this queue and processes them by extracting relevant data and generating the required agent configuration for the selected provider before launching the requested instance.</p>
<h2 id="terminology" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#terminology" rel="noreferrer" aria-label="Terminology permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>Terminology</h2>
<ul>
<li>Agent: A Buildkite agent which is backed by an instance launched in one of the supported cloud providers.</li>
<li>Agent Query Rules: A key-value list of tags specified as part of the Buildkite Job. See <a class="euiLink euiLink--primary" href="https://buildkite.com/docs/agent/v3/cli-start#agent-targeting" rel="noreferrer">agent targeting<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--small euiIcon-isLoading euiLink__externalIcon" focusable="false" role="img" aria-label="External link" aria-hidden="true"></svg></a> for more information.</li>
<li>Event Queue: An internal First-In First-Out (FIFO) queue used for storing and retrieving events that Gobld needs to action.</li>
<li>Instance: A cloud instance, such as Kubernetes pod or a Google Cloud Engine VM.</li>
<li>Provider config: This is configuration that is required to support launching and managing instances within the specified cloud provider.</li>
<li>Provider defaults: This is configuration that is used as the default for any instance launched in this cloud provider. Any supplied values are merged with the default configuration before launching the instance.</li>
<li>Webhook event: A webhook event is a notification that something has happened. The Buildkite notification service supports sending webhook events for a number of different events: <a class="euiLink euiLink--primary" href="https://buildkite.com/docs/apis/webhooks" rel="noreferrer">Buildkite Webhook docs<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--small euiIcon-isLoading euiLink__externalIcon" focusable="false" role="img" aria-label="External link" aria-hidden="true"></svg></a></li>
</ul>
<h2 id="how-it-works" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#how-it-works" rel="noreferrer" aria-label="How it works permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>How it works</h2>
<h3 id="happy-flow" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#happy-flow" rel="noreferrer" aria-label="Happy flow permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>Happy flow</h3>
<p>This is a high level walkthrough of the happy flow of Gobld.<br/>
<!-- -->We are going to cover everything that happens from when a Buildkite pipeline run is triggered until the agent is destroyed.</p>
<div><div class="language-mermaid euiCodeBlock euiCodeBlock--fontSmall euiCodeBlock--paddingSmall"><pre class="euiCodeBlock__pre euiCodeBlock__pre--whiteSpacePre" tabindex="-1"><code class="euiCodeBlock__code" data-code-language="text"><span class="euiCodeBlock__line">sequenceDiagram
</span><span class="euiCodeBlock__line">participant bk as Buildkite
</span><span class="euiCodeBlock__line">participant api as Gobld API
</span><span class="euiCodeBlock__line">participant eventQueue as Gobld Event Queue
</span><span class="euiCodeBlock__line">participant creator as Gobld Creator
</span><span class="euiCodeBlock__line">participant provider as Gobld Provider
</span><span class="euiCodeBlock__line">
</span><span class="euiCodeBlock__line">par Webhook handling
</span><span class="euiCodeBlock__line">    bk-&gt;&gt;api: Webhook event
</span><span class="euiCodeBlock__line">    activate api
</span><span class="euiCodeBlock__line">    api-&gt;&gt;api: Validate and verify
</span><span class="euiCodeBlock__line">    api-&gt;&gt;api: Process &quot;job.scheduled&quot; event
</span><span class="euiCodeBlock__line">    api-&gt;&gt;eventQueue: Add event
</span><span class="euiCodeBlock__line">    api--&gt;&gt;bk: Accept webhook event
</span><span class="euiCodeBlock__line">    deactivate api
</span><span class="euiCodeBlock__line">and Event processing
</span><span class="euiCodeBlock__line">    loop
</span><span class="euiCodeBlock__line">    creator-&gt;&gt;eventQueue: Get Event from queue
</span><span class="euiCodeBlock__line">    end
</span><span class="euiCodeBlock__line">    eventQueue-&gt;&gt;creator: Receive job event
</span><span class="euiCodeBlock__line">    activate creator
</span><span class="euiCodeBlock__line">    creator-&gt;&gt;creator: Process Agent Query Rules
</span><span class="euiCodeBlock__line">    creator-&gt;&gt;creator: Generate configuration
</span><span class="euiCodeBlock__line">    creator-&gt;&gt;creator: Generate Agent name
</span><span class="euiCodeBlock__line">    creator-&gt;&gt;provider: Create instance
</span><span class="euiCodeBlock__line">    activate provider
</span><span class="euiCodeBlock__line">    provider-&gt;&gt;provider: Watch instance status
</span><span class="euiCodeBlock__line">    alt Instance creation succeeded
</span><span class="euiCodeBlock__line">        provider-&gt;&gt;creator: Instance running
</span><span class="euiCodeBlock__line">    else Instance creation failed
</span><span class="euiCodeBlock__line">        provider-&gt;&gt;creator: Error returned
</span><span class="euiCodeBlock__line">        deactivate provider
</span><span class="euiCodeBlock__line">        creator-&gt;&gt;bk: Build cancelled and annotated
</span><span class="euiCodeBlock__line">    end
</span><span class="euiCodeBlock__line">    deactivate creator
</span><span class="euiCodeBlock__line">end
</span><span class="euiCodeBlock__line"></span></code></pre></div></div>
<h2 id="each-loop-of-gobld-will-be-separated-with-a-line-break" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#each-loop-of-gobld-will-be-separated-with-a-line-break" rel="noreferrer" aria-label="Each loop of Gobld will be separated with a line break. permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>Each loop of Gobld will be separated with a line break.</h2>
<ul>
<li>Gobld receives a webhook event notification from Buildkite. This event is validated and verified.</li>
<li>If the event passes the required checks, and is a <code class="euiCode" data-code-language="text">job.scheduled</code> event then it&#x27;s added in an in-memory Event Queue.</li>
</ul>
<style data-emotion="css 1y8hjhe-euiHorizontalRule-full-l">.css-1y8hjhe-euiHorizontalRule-full-l{border:none;height:1px;background-color:#343741;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-box-flex:0;-webkit-flex-grow:0;-ms-flex-positive:0;flex-grow:0;width:100%;margin-block:24px;}</style><hr class="euiHorizontalRule euiHorizontalRule--full euiHorizontalRule--marginLarge css-1y8hjhe-euiHorizontalRule-full-l"/>
<ul>
<li>Gobld checks to see if there are any events on the event queue.</li>
<li>If an event is present, Gobld processes that event by extracting several elements from the event payload, such as the Job ID and Agent Query Rules in order to generate the correct agent configuration and cloud instance.</li>
<li>Gobld processes the Agent Query Rules and generates an agent and instance configuration, and also selects the requested Cloud provider.</li>
<li>Gobld generates a name value based on the configured <code class="euiCode" data-code-language="text">prefix</code>, selected Cloud provider and a generated timestamp.</li>
<li>Gobld creates the instance in the relevant cloud provider.</li>
<li>Gobld watches the instance to ensure that it launches within a configurable time period.</li>
<li>If the instance fails to launch then the Buildkite build gets cancelled and annotated with further details of the failure.</li>
</ul>
<hr class="euiHorizontalRule euiHorizontalRule--full euiHorizontalRule--marginLarge css-1y8hjhe-euiHorizontalRule-full-l"/>
<p>Separately Gobld is checking for cloud instances that are no longer running and deletes them to free up resources.</p>
<h3 id="event-queue" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#event-queue" rel="noreferrer" aria-label="Event Queue permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>Event Queue</h3>
<p>The current design of Gobld leverages an internal &quot;in-memory&quot; event queue to store webhook event notifications that have been received but not yet processed.</p>
<p>The fact that the queue is &quot;in-memory&quot; means that it is quick and easy to utilise with no external dependencies.
However it does have the potential for event-loss if Gobld was to restart with events still in the queue.</p>
<p>In order to try and prevent this scenario, Gobld has been written to gracefully handle the <code class="euiCode" data-code-language="text">SIGTERM</code> event that Kubernetes uses to signal a pod to terminate. <a class="euiLink euiLink--primary" href="https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination" rel="noreferrer">ref<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--small euiIcon-isLoading euiLink__externalIcon" focusable="false" role="img" aria-label="External link" aria-hidden="true"></svg></a><br/>
<!-- -->Once a <code class="euiCode" data-code-language="text">SIGTERM</code> signal is received, Gobld will process the events it currently has in memory and then terminate.</p>
<p>In the future, this &quot;in-memory&quot; queue might be replaced with an external queue, such as GCP Pub/Sub.</p>
<h3 id="what-happens-if-an-instance-fails-to-launch-or-connect" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#what-happens-if-an-instance-fails-to-launch-or-connect" rel="noreferrer" aria-label="What happens if an instance fails to launch or connect? permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>What happens if an instance fails to launch or connect?</h3>
<p>This is most likely to occur if an instance image fails to start or fails to connect to Buildkite.<br/>
<!-- -->In this scenario Gobld will <a class="euiLink euiLink--primary" href="https://buildkite.com/docs/agent/v3/cli-annotate" rel="noreferrer">annotate<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--small euiIcon-isLoading euiLink__externalIcon" focusable="false" role="img" aria-label="External link" aria-hidden="true"></svg></a> the Buildkite build with the error that was returned when attempting to create or launch the agent.<br/>
<!-- -->Gobld will also cancel the build to prevent it hanging indefinitely.</p>
<p>Human intervention is likely needed to identify the root cause of the issue and undertake any required corrective action.</p>
<h3 id="why-does-gobld-use-a-timestamp-in-the-name" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#why-does-gobld-use-a-timestamp-in-the-name" rel="noreferrer" aria-label="Why does Gobld use a timestamp in the name? permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>Why does Gobld use a timestamp in the name?</h3>
<p>This was the simplest way to have a cross system way of generating a unique name that could also be used to determine the age of the instance.
This is required so that Gobld can automatically prune any running instances that are older than the specified <code class="euiCode" data-code-language="text">max-age</code> value.</p>
<h3 id="how-does-gobld-let-us-know-when-it-needs-help" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#how-does-gobld-let-us-know-when-it-needs-help" rel="noreferrer" aria-label="How does Gobld let us know when it needs help? permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>How does Gobld let us know when it needs help?</h3>
<p>Gobld generates log messages which are processed by Llama. Alerts will be generated for the following situations:
TODO: Validate these alerts are still relevant/functional with Buildkite.</p>
<ol>
<li>Expiry alerts when a deployment stops sending events to Llama</li>
<li>Alert for GCP errors (global alert shared between all controllers)</li>
</ol>
<p>You can read about how to deal with these alerts in the <a class="euiLink euiLink--primary" href="./troubleshooting.md" rel="noreferrer">troubleshooting documentation</a></p>
<h3 id="how-does-gobld-handle-multiple-providers" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#how-does-gobld-handle-multiple-providers" rel="noreferrer" aria-label="How does Gobld handle multiple providers? permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>How does Gobld handle multiple providers?</h3>
<h4 id="launching-instances" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#launching-instances" rel="noreferrer" aria-label="Launching instances permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>Launching instances</h4>
<p>Gobld supports specifying the required Cloud provider as part of the Agent query rules using the <code class="euiCode" data-code-language="text">provider</code> tag.<br/>
<!-- -->If a provider is not specified, the Kubernetes (<code class="euiCode" data-code-language="text">k8s</code>) provider is used.</p>
<h4 id="handling-provider-failures" style="position:relative"><a class="euiLink euiLink--primary docArticle__headerLink" href="#handling-provider-failures" rel="noreferrer" aria-label="Handling provider failures permalink"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" class="euiIcon euiIcon--medium euiIcon-isLoading" focusable="false" role="img" aria-hidden="true"></svg></a>Handling provider failures</h4>
<p>Gobld follows the following rules for handling with different kind of failures. We want to make sure that Gobld can continue to function as much as possible even when a single provider is down.</p>
<p>TODO: Validate gobld behaviour with Buildkite and provider failures.</p></div><div class="euiSpacer euiSpacer--l css-jz428s-euiSpacer-l"></div><div class="euiText euiText--small"><div class="euiTextColor euiTextColor--subdued">Last updated: Mar 28th, 2022</div></div></div></div></div></div></div></div><footer class="docChromeFooter" data-elastic-exclude="true"><div class="euiFlexGroup euiFlexGroup--justifyContentSpaceAround euiFlexGroup--directionRow euiFlexGroup--responsive"><div class="euiFlexItem euiFlexItem--flexGrowZero docChromeFooter__container"><div class="euiFlexGroup euiFlexGroup--gutterExtraLarge euiFlexGroup--justifyContentSpaceBetween euiFlexGroup--directionRow euiFlexGroup--responsive"><div class="euiFlexItem"><div class="euiText euiText--small"><div class="euiTextColor euiTextColor--ghost"><p>Elasticsearch is a trademark of Elasticsearch B.V., registered in the U.S. and in other countries.</p><p>Apache, Apache Lucene, Apache Hadoop, Hadoop, HDFS and the yellow elephant logo are trademarks of the Apache Software Foundation in the United States and/or other countries.</p><p> <a class="euiLink euiLink--ghost" href="https://www.elastic.co/legal/trademarks" rel="">Trademarks</a><span class="docChromeFooter__divide">|</span><a class="euiLink euiLink--ghost" href="https://www.elastic.co/legal/terms-of-use" rel="">Terms of Use</a><span class="docChromeFooter__divide">|</span><a class="euiLink euiLink--ghost" href="https://www.elastic.co/legal/privacy-statement" rel="">Privacy</a><span class="docChromeFooter__divide">|</span>© <!-- -->2022<!-- --> Elasticsearch B.V. All Rights Reserved</p></div></div></div><div class="euiFlexItem euiFlexItem--flexGrowZero"></div><div class="euiFlexItem euiFlexItem--flexGrowZero"><figure class="euiImage docChromeFooter__logo"><img style="max-width:xs;max-height:xs;width:auto" src="/assets/images/logo-elastic-vertical-reverse.svg" class="euiImage__img" alt="Elastic logo"/></figure></div></div></div></div></footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"bundle":"!function(e,t){\"object\"==typeof exports\u0026\u0026\"object\"==typeof module?module.exports=t(require(\"mdxJsReact\"),require(\"React\")):\"function\"==typeof define\u0026\u0026define.amd?define([\"mdxJsReact\",\"React\"],t):\"object\"==typeof exports?exports.MDXContent=t(require(\"mdxJsReact\"),require(\"React\")):e.MDXContent=t(e.mdxJsReact,e.React)}(this,((e,t)=\u003e(()=\u003e{\"use strict\";var n={24:e=\u003e{e.exports=t},825:t=\u003e{t.exports=e}},a={};function r(e){var t=a[e];if(void 0!==t)return t.exports;var i=a[e]={exports:{}};return n[e](i,i.exports,r),i.exports}r.n=e=\u003e{var t=e\u0026\u0026e.__esModule?()=\u003ee.default:()=\u003ee;return r.d(t,{a:t}),t},r.d=(e,t)=\u003e{for(var n in t)r.o(t,n)\u0026\u0026!r.o(e,n)\u0026\u0026Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=\u003eObject.prototype.hasOwnProperty.call(e,t),r.r=e=\u003e{\"undefined\"!=typeof Symbol\u0026\u0026Symbol.toStringTag\u0026\u0026Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})};var i={};return(()=\u003e{r.r(i),r.d(i,{default:()=\u003ea});var e=r(825),t=r(24),n=r.n(t);const a=function(){var t=arguments.length\u003e0\u0026\u0026void 0!==arguments[0]?arguments[0]:{},a=Object.assign({},(0,e.useMDXComponents)(),t.components),r=a.wrapper;return r?n().createElement(r,t,n().createElement(i)):i();function i(){var a=Object.assign({p:\"p\",br:\"br\",h2:\"h2\",ul:\"ul\",li:\"li\",a:\"a\",h3:\"h3\",pre:\"pre\",code:\"code\",hr:\"hr\",ol:\"ol\",h4:\"h4\"},(0,e.useMDXComponents)(),t.components);return n().createElement(n().Fragment,null,n().createElement(a.p,null,\"The design goal of Gobld is to be stateless and as simple as possible.\"),\"\\n\",n().createElement(a.p,null,\"Webhook events are received via an API call from the Buildkite notification service and initially placed on an in-memory event queue.\",n().createElement(a.br),\"\\n\",\"An internal loop then pulls events from this queue and processes them by extracting relevant data and generating the required agent configuration for the selected provider before launching the requested instance.\"),\"\\n\",n().createElement(a.h2,{id:\"terminology\"},\"Terminology\"),\"\\n\",n().createElement(a.ul,null,\"\\n\",n().createElement(a.li,null,\"Agent: A Buildkite agent which is backed by an instance launched in one of the supported cloud providers.\"),\"\\n\",n().createElement(a.li,null,\"Agent Query Rules: A key-value list of tags specified as part of the Buildkite Job. See \",n().createElement(a.a,{href:\"https://buildkite.com/docs/agent/v3/cli-start#agent-targeting\"},\"agent targeting\"),\" for more information.\"),\"\\n\",n().createElement(a.li,null,\"Event Queue: An internal First-In First-Out (FIFO) queue used for storing and retrieving events that Gobld needs to action.\"),\"\\n\",n().createElement(a.li,null,\"Instance: A cloud instance, such as Kubernetes pod or a Google Cloud Engine VM.\"),\"\\n\",n().createElement(a.li,null,\"Provider config: This is configuration that is required to support launching and managing instances within the specified cloud provider.\"),\"\\n\",n().createElement(a.li,null,\"Provider defaults: This is configuration that is used as the default for any instance launched in this cloud provider. Any supplied values are merged with the default configuration before launching the instance.\"),\"\\n\",n().createElement(a.li,null,\"Webhook event: A webhook event is a notification that something has happened. The Buildkite notification service supports sending webhook events for a number of different events: \",n().createElement(a.a,{href:\"https://buildkite.com/docs/apis/webhooks\"},\"Buildkite Webhook docs\")),\"\\n\"),\"\\n\",n().createElement(a.h2,{id:\"how-it-works\"},\"How it works\"),\"\\n\",n().createElement(a.h3,{id:\"happy-flow\"},\"Happy flow\"),\"\\n\",n().createElement(a.p,null,\"This is a high level walkthrough of the happy flow of Gobld.\",n().createElement(a.br),\"\\n\",\"We are going to cover everything that happens from when a Buildkite pipeline run is triggered until the agent is destroyed.\"),\"\\n\",n().createElement(a.pre,null,n().createElement(a.code,{className:\"language-mermaid\",display:\"block\"},'sequenceDiagram\\nparticipant bk as Buildkite\\nparticipant api as Gobld API\\nparticipant eventQueue as Gobld Event Queue\\nparticipant creator as Gobld Creator\\nparticipant provider as Gobld Provider\\n\\npar Webhook handling\\n    bk-\u003e\u003eapi: Webhook event\\n    activate api\\n    api-\u003e\u003eapi: Validate and verify\\n    api-\u003e\u003eapi: Process \"job.scheduled\" event\\n    api-\u003e\u003eeventQueue: Add event\\n    api--\\x3e\u003ebk: Accept webhook event\\n    deactivate api\\nand Event processing\\n    loop\\n    creator-\u003e\u003eeventQueue: Get Event from queue\\n    end\\n    eventQueue-\u003e\u003ecreator: Receive job event\\n    activate creator\\n    creator-\u003e\u003ecreator: Process Agent Query Rules\\n    creator-\u003e\u003ecreator: Generate configuration\\n    creator-\u003e\u003ecreator: Generate Agent name\\n    creator-\u003e\u003eprovider: Create instance\\n    activate provider\\n    provider-\u003e\u003eprovider: Watch instance status\\n    alt Instance creation succeeded\\n        provider-\u003e\u003ecreator: Instance running\\n    else Instance creation failed\\n        provider-\u003e\u003ecreator: Error returned\\n        deactivate provider\\n        creator-\u003e\u003ebk: Build cancelled and annotated\\n    end\\n    deactivate creator\\nend\\n')),\"\\n\",n().createElement(a.h2,{id:\"each-loop-of-gobld-will-be-separated-with-a-line-break\"},\"Each loop of Gobld will be separated with a line break.\"),\"\\n\",n().createElement(a.ul,null,\"\\n\",n().createElement(a.li,null,\"Gobld receives a webhook event notification from Buildkite. This event is validated and verified.\"),\"\\n\",n().createElement(a.li,null,\"If the event passes the required checks, and is a \",n().createElement(a.code,{display:\"inline\"},\"job.scheduled\"),\" event then it's added in an in-memory Event Queue.\"),\"\\n\"),\"\\n\",n().createElement(a.hr),\"\\n\",n().createElement(a.ul,null,\"\\n\",n().createElement(a.li,null,\"Gobld checks to see if there are any events on the event queue.\"),\"\\n\",n().createElement(a.li,null,\"If an event is present, Gobld processes that event by extracting several elements from the event payload, such as the Job ID and Agent Query Rules in order to generate the correct agent configuration and cloud instance.\"),\"\\n\",n().createElement(a.li,null,\"Gobld processes the Agent Query Rules and generates an agent and instance configuration, and also selects the requested Cloud provider.\"),\"\\n\",n().createElement(a.li,null,\"Gobld generates a name value based on the configured \",n().createElement(a.code,{display:\"inline\"},\"prefix\"),\", selected Cloud provider and a generated timestamp.\"),\"\\n\",n().createElement(a.li,null,\"Gobld creates the instance in the relevant cloud provider.\"),\"\\n\",n().createElement(a.li,null,\"Gobld watches the instance to ensure that it launches within a configurable time period.\"),\"\\n\",n().createElement(a.li,null,\"If the instance fails to launch then the Buildkite build gets cancelled and annotated with further details of the failure.\"),\"\\n\"),\"\\n\",n().createElement(a.hr),\"\\n\",n().createElement(a.p,null,\"Separately Gobld is checking for cloud instances that are no longer running and deletes them to free up resources.\"),\"\\n\",n().createElement(a.h3,{id:\"event-queue\"},\"Event Queue\"),\"\\n\",n().createElement(a.p,null,'The current design of Gobld leverages an internal \"in-memory\" event queue to store webhook event notifications that have been received but not yet processed.'),\"\\n\",n().createElement(a.p,null,'The fact that the queue is \"in-memory\" means that it is quick and easy to utilise with no external dependencies.\\nHowever it does have the potential for event-loss if Gobld was to restart with events still in the queue.'),\"\\n\",n().createElement(a.p,null,\"In order to try and prevent this scenario, Gobld has been written to gracefully handle the \",n().createElement(a.code,{display:\"inline\"},\"SIGTERM\"),\" event that Kubernetes uses to signal a pod to terminate. \",n().createElement(a.a,{href:\"https://kubernetes.io/docs/concepts/workloads/pods/pod-lifecycle/#pod-termination\"},\"ref\"),n().createElement(a.br),\"\\n\",\"Once a \",n().createElement(a.code,{display:\"inline\"},\"SIGTERM\"),\" signal is received, Gobld will process the events it currently has in memory and then terminate.\"),\"\\n\",n().createElement(a.p,null,'In the future, this \"in-memory\" queue might be replaced with an external queue, such as GCP Pub/Sub.'),\"\\n\",n().createElement(a.h3,{id:\"what-happens-if-an-instance-fails-to-launch-or-connect\"},\"What happens if an instance fails to launch or connect?\"),\"\\n\",n().createElement(a.p,null,\"This is most likely to occur if an instance image fails to start or fails to connect to Buildkite.\",n().createElement(a.br),\"\\n\",\"In this scenario Gobld will \",n().createElement(a.a,{href:\"https://buildkite.com/docs/agent/v3/cli-annotate\"},\"annotate\"),\" the Buildkite build with the error that was returned when attempting to create or launch the agent.\",n().createElement(a.br),\"\\n\",\"Gobld will also cancel the build to prevent it hanging indefinitely.\"),\"\\n\",n().createElement(a.p,null,\"Human intervention is likely needed to identify the root cause of the issue and undertake any required corrective action.\"),\"\\n\",n().createElement(a.h3,{id:\"why-does-gobld-use-a-timestamp-in-the-name\"},\"Why does Gobld use a timestamp in the name?\"),\"\\n\",n().createElement(a.p,null,\"This was the simplest way to have a cross system way of generating a unique name that could also be used to determine the age of the instance.\\nThis is required so that Gobld can automatically prune any running instances that are older than the specified \",n().createElement(a.code,{display:\"inline\"},\"max-age\"),\" value.\"),\"\\n\",n().createElement(a.h3,{id:\"how-does-gobld-let-us-know-when-it-needs-help\"},\"How does Gobld let us know when it needs help?\"),\"\\n\",n().createElement(a.p,null,\"Gobld generates log messages which are processed by Llama. Alerts will be generated for the following situations:\\nTODO: Validate these alerts are still relevant/functional with Buildkite.\"),\"\\n\",n().createElement(a.ol,null,\"\\n\",n().createElement(a.li,null,\"Expiry alerts when a deployment stops sending events to Llama\"),\"\\n\",n().createElement(a.li,null,\"Alert for GCP errors (global alert shared between all controllers)\"),\"\\n\"),\"\\n\",n().createElement(a.p,null,\"You can read about how to deal with these alerts in the \",n().createElement(a.a,{href:\"./troubleshooting.md\"},\"troubleshooting documentation\")),\"\\n\",n().createElement(a.h3,{id:\"how-does-gobld-handle-multiple-providers\"},\"How does Gobld handle multiple providers?\"),\"\\n\",n().createElement(a.h4,{id:\"launching-instances\"},\"Launching instances\"),\"\\n\",n().createElement(a.p,null,\"Gobld supports specifying the required Cloud provider as part of the Agent query rules using the \",n().createElement(a.code,{display:\"inline\"},\"provider\"),\" tag.\",n().createElement(a.br),\"\\n\",\"If a provider is not specified, the Kubernetes (\",n().createElement(a.code,{display:\"inline\"},\"k8s\"),\") provider is used.\"),\"\\n\",n().createElement(a.h4,{id:\"handling-provider-failures\"},\"Handling provider failures\"),\"\\n\",n().createElement(a.p,null,\"Gobld follows the following rules for handling with different kind of failures. We want to make sure that Gobld can continue to function as much as possible even when a single provider is down.\"),\"\\n\",n().createElement(a.p,null,\"TODO: Validate gobld behaviour with Buildkite and provider failures.\"))}}})(),i})()));","frontmatter":{"id":"ciGobldDesign","slug":"/ci/gobld/design","title":"Design","summary":"Gobld design documentation","date":"2022-03-28T00:00:00.000Z","tags":["ci","ci/cd","developer tools","buildkite","gobld","engineering","platform"],"link":"https://github.com/elastic/ci/blob/main","linkPath":"docs/gobld/design.mdx"},"missionId":"krVideos"},"__N_SSG":true},"page":"/[...slug]","query":{"slug":["ci","gobld","design"]},"buildId":"AzE3g5BBfFWf9aUdpqGZ7","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>